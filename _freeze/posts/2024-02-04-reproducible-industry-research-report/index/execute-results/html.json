{
  "hash": "087a2408bb8bfc8ea0a4c60a573e21af",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"可复现行业研究报告数据源 lixingr\"\nauthor: \"谭 长德\"\ndate: 2024-02-04\nimage: \"image/gabriel-sollmann-Y7d265_7i08-unsplash.jpg\"\nnumber-sections: true\ncategories: [\"脚手架\"]\nknitr:\n  opts_chunk: \n    echo: true\n    message: FALSE\n    warning: FALSE\n    cache: TRUE\n    collapse: true\n    comment: \"#>\" \n    R.options:\n      knitr.graphics.auto_pdf: true\n---\n\n\n![](image/gabriel-sollmann-Y7d265_7i08-unsplash.jpg)\n\n## 初心动机\n\n人之为人，在于一缕灵明。从人手中拿走机器也可以做的，剩下便是这一缕灵明。所以，一切可以自动化的都应该自动化。但案头研究工作中，充斥着拖拉点拽复制粘贴。因为对办公软件而言，使用方式越直观上手越快，可以尽可能扩大用户群体。但要享受内容创作，就得让创作的归创作，机械的归机械。我们可以借鉴“[文学化编程](https://yihui.org/cn/2014/01/literate-programming/)”，将“可复现科学研究”应用于“可复现行业研究”。\n\n“可复现研究”类似编程。也需要借助版本控制、多人协作、多源数据，及开源世界。无需担心学习时间成本，借助大语言模型，基本入门一周足矣。“可复现研究”让你在一份文档中，混排文本与代码，代码执行结果将嵌入文档。研究始末均以文字记录，包括数据处理、图表绘制、结果分析等。有了代码，各类整洁数据任君差遣，而不必从头整理。纯文本内容，杜绝了交互操作。这意味着，任何人拿到项目文本，就可以重新生成同样的报告。我们还可以使用版本控制工具记录版本，识别任何时点之间的改动。结合 Quarto，我们甚至可以实现“一处写就，多处成就”，即一份文档多种输出。这样一来，你只需专心创作内容，而不必为数据整理、内容排版、输出格式等机械重复分散心力。\n\n综合数据质量与使用成本，我将理杏仁数据接口封装成了 R 语言包：[lixingr](https://github.com/tanchangde/lixingr)。目前已完成[接口文档](https://www.lixinger.com/open/api/doc)下中国大陆与中国香港公司接口封装，欢迎试用，反馈，共同完善。\n\n## 先睹为快\n\n利用 lixingr 包调用理杏仁接口，按年查询 2018 年以来顺丰速运 PE TTM。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(lixingr)\n\nlxr_query(\n  endpoint = lxr_cn_company_fs_non_financial(),\n  start_date = \"2018-01-01\",\n  end_date = \"2024-02-05\",\n  stock_codes = \"002352\",\n  metrics_list = \"y.bs.pe_ttm.t\"\n)\n#> # A tibble: 5 × 7\n#>   reportType    reportDate   currency standardDate date  stockCode y.bs.pe_ttm.t\n#>   <chr>         <chr>        <chr>    <chr>        <chr> <chr>             <dbl>\n#> 1 annual_report 2023-03-29T… CNY      2022-12-31T… 2022… 002352             40.7\n#> 2 annual_report 2022-03-31T… CNY      2021-12-31T… 2021… 002352             95.9\n#> 3 annual_report 2021-03-18T… CNY      2020-12-31T… 2020… 002352             56.8\n#> 4 annual_report 2020-03-24T… CNY      2019-12-31T… 2019… 002352             28.1\n#> 5 annual_report 2019-03-16T… CNY      2018-12-31T… 2018… 002352             34.8\n```\n:::\n\n\n## 环境配置\n\n请参考[这个资料](https://bookdown.org/wangminjie/R4DS/baseR-install.html)，安装与配置环境，并了解 RStudio 的基础用法。\n\n打开 RStudio，在 Console 中输入以下命令并按下回车键，检查是否成功安装了 R：\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n#> R version 4.3.0 (2023-04-21)\n#> Platform: x86_64-apple-darwin20 (64-bit)\n#> Running under: macOS Ventura 13.6.3\n#> \n#> Matrix products: default\n#> BLAS:   /Library/Frameworks/R.framework/Versions/4.3-x86_64/Resources/lib/libRblas.0.dylib \n#> LAPACK: /Library/Frameworks/R.framework/Versions/4.3-x86_64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0\n#> \n#> locale:\n#> [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n#> \n#> time zone: Asia/Shanghai\n#> tzcode source: internal\n#> \n#> attached base packages:\n#> [1] stats     graphics  grDevices utils     datasets  methods   base     \n#> \n#> other attached packages:\n#> [1] DT_0.31       knitr_1.45    lixingr_0.1.0\n#> \n#> loaded via a namespace (and not attached):\n#>  [1] vctrs_0.6.5       cli_3.6.2         rlang_1.1.3       xfun_0.41        \n#>  [5] stringi_1.8.3     purrr_1.0.2       generics_0.1.3    jsonlite_1.8.8   \n#>  [9] glue_1.7.0        htmltools_0.5.7   fansi_1.0.6       rmarkdown_2.25   \n#> [13] rappdirs_0.3.3    evaluate_0.23     tibble_3.2.1      fastmap_1.1.1    \n#> [17] yaml_2.3.8        lifecycle_1.0.4   httr2_1.0.0       stringr_1.5.1    \n#> [21] compiler_4.3.0    codetools_0.2-19  dplyr_1.1.4       fs_1.6.3         \n#> [25] htmlwidgets_1.6.4 pkgconfig_2.0.3   tidyr_1.3.1       rstudioapi_0.15.0\n#> [29] digest_0.6.34     R6_2.5.1          tidyselect_1.2.0  utf8_1.2.4       \n#> [33] curl_5.2.0        usethis_2.2.2     pillar_1.9.0      magrittr_2.0.3   \n#> [37] tools_4.3.0\n```\n:::\n\n\n你看到的内容会有所不同，但若出现了 R 版本号，在上文中为 “R version 4.3.0 (2023-04-21)”，则说明你已经成功安装了 R。若失败，请救助搜索引擎或大语言模型。比如“windows 安装 R”。\n\n接着我们需要安装 devtools 包，因为 lixingr 还未发布到 CRAN，只能通过 GitHub 安装。\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages(\"devtools\")\n```\n:::\n\n\n透过 devtools 包，我们可以将托管在 GitHub 上的 lixingr 包安装到本地。\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndevtools::install_github('tanchangde/lixingr')\n```\n:::\n\n\n注册并登录到理杏仁，然后从[开放平台](https://www.lixinger.com/open/api/token)获取一个 Token。在 Console 输入 `file.edit(\"~/.Renviron\")`，然后在打开的文件中添加一行新的内容：`TOKEN_LIXINGER = \"已获取的 Token\"`，保存并关闭 `.Renviron` 文件。这样我们调用理杏仁接口时，就不用显式声明 Token，分享项目代码给他人时更安全。\n\n至此，我们可以重启 RStudio 并新建一个 R 脚本文件。输入并执行如下代码，可以帮我们将 lixingr 包加载到当前环境:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(lixingr)\n```\n:::\n\n\n我们便能够直接使用 lixingr 包中的函数了。\n\n## 用法提示\n\nlixingr 包主函数是 `lxr_query()`，在 Console 中输入 `?lxr_query` 后回车，你可以看到函数文档。\n\n为与官方接口设计保持一致，同时方便赋值 `endpoint` 参数。lixingr 包提供了 `lxr_cn` 或 `lxr_hk` 等开头的函数，可以返回理杏仁接口端点（API endpoint）。比如，`lxr_cn_company_fs_non_financial()`， 可以返回中国大陆非金融上市公司财务数据端点。\n\n为避免复述接口端点参数（其实是偷懒），你需要在[理杏仁接口文档](https://www.lixinger.com/open/api/)查看对应端点的参数说明，并为 `lxr_query()` 提供参数。参数可使用驼峰命名法，亦可用下划线命名法。\n\n`lxr_query()` 会帮你检查输入参数是否合法、必要参数是否缺失。在理杏仁接口文档标识为数组的参数，你只需要以字符向量的形式输入即可。函数会自动帮你转换。\n\n比如，理杏仁[大陆上市公司基础信息接口端点](https://www.lixinger.com/open/api/doc?api-key=cn/company/profile)文档，同时查询多家大陆上市公司基础信息，需要这样写：\n\n```json\n{\n\t\"token\": \"......\",\n\t\"stockCodes\": [\n\t\t\"300750\",\n\t\t\"600519\",\n\t\t\"600157\"\n\t]\n}\n```\n\n而使用 lixingr 包，你只需要这样写：\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlxr_query(\n  endpoint = lxr_cn_company_profile(),\n  stock_codes = c(\"300750\", \"600519\", \"600157\")\n)\n#> # A tibble: 8 × 21\n#>   registeredCapital boardSecretory postalCode businessScope               city  \n#>               <dbl> <chr>          <chr>      <chr>                       <chr> \n#> 1        4399041236 蒋理           352100     锂离子电池、锂聚合物电池、… 宁德市\n#> 2        4399041236 蒋理           352100     锂离子电池、锂聚合物电池、… 宁德市\n#> 3        4399041236 蒋理           352100     锂离子电池、锂聚合物电池、… 宁德市\n#> 4       22217764145 李军           030006     综合能源开发；大宗商品物流… 晋中市\n#> 5       22217764145 李军           030006     综合能源开发；大宗商品物流… 晋中市\n#> 6       22217764145 李军           030006     综合能源开发；大宗商品物流… 晋中市\n#> 7        1256197800 蒋焰           564501     茅台酒系列产品的生产与销售… 遵义市\n#> 8       22217764145 李军           030006     综合能源开发；大宗商品物流… 晋中市\n#> # ℹ 16 more variables: registeredAddress <chr>, fax <chr>, province <chr>,\n#> #   email <chr>, generalManager <chr>, establishDate <chr>, profile <chr>,\n#> #   officeAddress <chr>, mainBusiness <chr>, legalRepresentative <chr>,\n#> #   contactNumber <chr>, website <chr>, companyName <chr>, chairman <chr>,\n#> #   independentDirectors <chr>, historyStockNames <chr>\n```\n:::\n\n\n## 参考资料\n\n- [Quarto](https://quarto.org/)\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}